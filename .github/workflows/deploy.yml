name: Stock Analyzer CI/CD

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      terraform_action:
        description: "Select Terraform action"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      skip_nochange:
        description: "Apply even if no changes detected?"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  pull-requests: write
  packages: write

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.9.5
  PYTHON_VERSION: '3.11'
  ROLE_NAME: data-analytics-tf-dev-role
  ARTIFACTS_BUCKET: data-analytics-dev-artifacts
  ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  DEPLOYMENT_PATH: root_modules/env/dev


# ---------------------------------------------------------
# 1) TERRAFORM PLAN (Runs only on PRs)
# ---------------------------------------------------------
jobs:
  Plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/${{ env.ROLE_NAME }}
          role-session-name: GitHubActions-Terraform-Plan-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform plan -no-color -out=tfplan


# ---------------------------------------------------------
# 2) TERRAFORM APPLY / PLAN / DESTROY (Push OR Manual)
# ---------------------------------------------------------
  Apply:
    runs-on: ubuntu-latest
    environment: Development

    # Push-to-main deployment OR manual workflow_dispatch
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch')

    steps:

      # -------------------------
      # Check out source code
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Python for Lambda packaging
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install boto3 yfinance

      # -------------------------
      # Package Lambda artifacts
      # -------------------------
      - name: Package stock producer Lambda
        run: |
          zip -r stock_producer.zip scripts/stock_producer.py

      - name: Package stock ingestor Lambda
        run: |
          zip -r stock_ingestor.zip scripts/stock_ingestor.py

      # -------------------------
      # AWS Credentials
      # -------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/${{ env.ROLE_NAME }}
          role-session-name: GitHubActions-Terraform-Apply-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      # -------------------------
      # Upload Artifacts
      # -------------------------
      - name: Upload producer lambda
        run: aws s3 cp stock_producer.zip s3://${{ env.ARTIFACTS_BUCKET }}/lambda/stock_producer.zip

      - name: Upload ingestor lambda
        run: aws.s3 cp stock_ingestor.zip s3://${{ env.ARTIFACTS_BUCKET }}/lambda/stock_ingestor.zip

      # -------------------------
      # Terraform Setup
      # -------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform init

      # -------------------------
      # Terraform PLAN (Always run before Apply/Destroy)
      # -------------------------
      - name: Terraform Plan (manual mode)
        id: manual_plan
        if: github.event_name == 'workflow_dispatch'
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform plan -no-color -out=tfplan

      - name: Detect plan changes
        id: check_changes
        if: github.event_name == 'workflow_dispatch'
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: |
          terraform show -no-color tfplan | grep -q "No changes" \
            && echo "changes=false" >> $GITHUB_OUTPUT \
            || echo "changes=true" >> $GITHUB_OUTPUT

      # -------------------------
      # Manual PLAN ONLY
      # -------------------------
      - name: Manual Terraform Plan Only
        if: github.event_name == 'workflow_dispatch' && inputs.terraform_action == 'plan'
        run: echo "Terraform action = PLAN only. No apply or destroy will run."

      # -------------------------
      # Manual APPLY
      # -------------------------
      - name: Terraform Apply (manual)
        if: |
          github.event_name == 'workflow_dispatch' &&
          inputs.terraform_action == 'apply' &&
          (inputs.skip_nochange == 'true' || steps.check_changes.outputs.changes == 'true')
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform apply -auto-approve

      # -------------------------
      # Manual DESTROY
      # -------------------------
      - name: Terraform Destroy (manual)
        if: github.event_name == 'workflow_dispatch' && inputs.terraform_action == 'destroy'
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform destroy -auto-approve

      # -------------------------
      # AUTO-APPLY for push-to-main
      # -------------------------
      - name: Terraform Apply (auto)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform apply -auto-approve

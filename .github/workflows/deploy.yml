name: Stock Analyzer CI/CD

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches: [main]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read
  pull-requests: write
  packages: write

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.9.5
  PYTHON_VERSION: '3.11'
  ROLE_NAME: data-analytics-tf-dev-role
  ARTIFACTS_BUCKET: data-analytics-dev-artifacts
  ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  DEPLOYMENT_PATH: root_modules/env/dev
  PRODUCER_ZIPPED_FILE_PATH: modules/lambda_producer
  INGEST_ZIPPED_FILE_PATH: modules/lambda_ingest

jobs:

  # ---------------------------------------------------------
  # 1) TERRAFORM PLAN (Runs on PR)
  # ---------------------------------------------------------
  Plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/${{ env.ROLE_NAME }}
          role-session-name: GitHubActions-Terraform-Plan-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Package producer lambda
        run: |
          zip -j ${{ env.PRODUCER_ZIPPED_FILE_PATH }}/stock_producer.zip scripts/stock_producer.py


      - name: Package stock ingestor Lambda
        run: |
          zip -j ${{ env.INGEST_ZIPPED_FILE_PATH }}/stock_ingestor.zip scripts/stock_ingestor.py

      - name: Terraform Init
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform plan -no-color -out=tfplan


  # ---------------------------------------------------------
  # 2) TERRAFORM APPLY + LAMBDA ARTIFACT UPLOAD
  # ---------------------------------------------------------
  Apply:
    runs-on: ubuntu-latest
    environment: Development
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch')

    steps:

      # -------------------------------------------
      # Checkout
      # -------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------
      # Python Setup (needed for packaging)
      # -------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install boto3 yfinance

      # -------------------------------------------
      # Package Lambda Functions (local ZIP)
      # Saved into the Terraform module directory
      # -------------------------------------------
      - name: Package stock producer lambda
        run: |
          zip -j ${{ env.PRODUCER_ZIPPED_FILE_PATH }}/stock_producer.zip scripts/stock_producer.py


      - name: Package stock ingestor Lambda
        run: |
          zip -j ${{ env.INGEST_ZIPPED_FILE_PATH }}/stock_ingestor.zip scripts/stock_ingestor.py

      # -------------------------------------------
      # Set up AWS credentials
      # -------------------------------------------
      - name: Configure AWS credentials (assume role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/${{ env.ROLE_NAME }}
          role-session-name: GitHubActions-Terraform-Apply-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      # -------------------------------------------
      # TERRAFORM APPLY (Creates the S3 bucket first)
      # -------------------------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ env.DEPLOYMENT_PATH }}
        run: terraform apply -auto-approve

      # -------------------------------------------
      # Upload ZIP to S3 AFTER bucket exists
      # -------------------------------------------
      - name: Upload producer lambda to S3
        run: |
          aws s3 cp ${{ env.PRODUCER_ZIPPED_FILE_PATH }}/stock_producer.zip \ # WORK ON THIS NOW
            s3://${{ env.ARTIFACTS_BUCKET }}/lambda/stock_producer.zip

      - name: Upload ingestor lambda to S3
        run: |
          aws s3 cp ${{ env.INGEST_ZIPPED_FILE_PATH }}/stock_ingestor.zip \
            s3://${{ env.ARTIFACTS_BUCKET }}/lambda/stock_ingestor.zip
